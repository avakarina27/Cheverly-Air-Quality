<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EJAT Air Quality Network</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    :root {
      --brand-navy: #1a305e !important;
      --search-blue: #4477ce !important;
      --orange: #f59e0b !important;
    }

    html, body {
      margin: 0 !important; padding: 0 !important;
      height: 100% !important; width: 100% !important;
      font-family: "Segoe UI", Tahoma, sans-serif !important;
      overflow: hidden !important; background: #fdfdfd !important;
    }

    .topbar {
      background: var(--brand-navy); color: white;
      padding: 0 25px; display: flex; justify-content: space-between;
      align-items: center; height: 60px; box-sizing: border-box; z-index: 2000;
    }
    .brand { font-size: 1.2rem; font-weight: bold; }
    .nav a { color: white; text-decoration: none; margin-left: 20px; font-size: 0.9rem; opacity: 0.8; }
    .nav a:hover { opacity: 1; text-decoration: underline; }

    #layout { display: flex; height: calc(100vh - 60px); width: 100vw; }

    #sidebar {
      width: 380px !important; min-width: 380px !important;
      background: #f4f6f8; border-right: 1px solid #ddd;
      padding: 15px; overflow-y: auto; box-sizing: border-box;
    }

    .card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ddd;
      margin-bottom: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    label {
      font-size: 0.7rem;
      font-weight: bold;
      color: #666;
      text-transform: uppercase;
      margin-bottom: 5px;
      display: block;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 8px;
      border-radius: 4px;
      border: none;
      background: var(--search-blue);
      color: white;
      font-weight: bold;
      cursor: pointer;
    }

    #main-content { flex: 1; display: flex; flex-direction: column; height: 100%; }
    #map { height: 45% !important; width: 100% !important; border-bottom: 1px solid #ddd; z-index: 1; }
    #chart-box { height: 55% !important; width: 100% !important; padding: 15px; box-sizing: border-box; background: white; }

    .aqi-val {
      font-size: 72px !important;
      font-weight: 900 !important;
      display: block;
      text-align: center;
      line-height: 1.1;
      text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
    }

    .subval {
      margin-top: 8px;
      font-size: 1.0rem;
      font-weight: 800;
      color: #333;
    }

    .sublabel {
      font-size: 0.75rem;
      color: #666;
      font-weight: 700;
      margin-top: 2px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #333;
    }

    .dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      margin-right: 12px;
      border: 2px solid #000 !important;
      display: inline-block;
    }

    .tri {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 18px solid var(--orange);
      margin-right: 12px;
      filter: drop-shadow(0px 0px 1px #000);
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">Cheverly Air Quality</div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="dashboard.html" style="font-weight:bold; opacity:1;">Dashboard</a>
    <a href="writeup.html">Community Insights</a>
  </nav>
</header>

<div id="layout">
  <aside id="sidebar">
    <div class="card">
      <label>Location Search</label>
      <input type="text" id="addrInput" placeholder="Enter Address">
      <button id="locateBtn">Find Nearest Station</button>
    </div>

    <div class="card">
      <label>Station Index</label>
      <select id="devSel" onchange="handleDropdownChange(this.value)"></select>
    </div>

    <div class="card" style="min-height: 170px;">
      <label>Live Station Reading</label>
      <div id="details" style="text-align:center;">
        <div id="statName" style="font-weight:bold; font-size:0.9rem; margin-bottom:5px; color:#333;">--</div>

        <div id="statAQI" class="aqi-val" style="color:#ccc;">--</div>
        <div style="font-size:0.75rem; color:#666; font-weight: bold; margin-top:5px;">CURRENT AQI</div>

        <div id="statCE" class="aqi-val" style="color:#ccc;">--</div>
        <div style="font-size:0.75rem; color:#666; font-weight: bold; margin-top:5px;">24 HOUR CE AQI</div>
      </div>
    </div>

    <div class="card">
      <label>Network Legend</label>

      <div class="legend-item"><span class="dot" style="background-color:#00e400;"></span> Good (0 to 50)</div>
      <div class="legend-item"><span class="dot" style="background-color:#ffff00;"></span> Moderate (51 to 100)</div>
      <div class="legend-item"><span class="dot" style="background-color:#ff7e00;"></span> Sensitive (101 to 150)</div>
      <div class="legend-item"><span class="dot" style="background-color:#ff0000;"></span> Unhealthy (151 plus)</div>

      <hr style="border:none;border-top:1px solid #ddd;margin:12px 0;">

      <div class="legend-item"><span class="dot" style="background-color:#999;"></span> PurpleAir (circle)</div>
      <div class="legend-item"><span class="tri" style="border-bottom-color:#999;"></span> QuantAQ (triangle)</div>

      <div style="margin-top:10px;font-size:0.75rem;color:#666;font-weight:700;">
        Station color is based on 24 hour CE AQI.
      </div>
    </div>
  </aside>

  <div id="main-content">
    <div id="map"></div>
    <div id="chart-box"><canvas id="airChart"></canvas></div>
  </div>
</div>

<script>
  const API_PROXY = "/api/aq";

  const SENSORS = {
    "284362": "EJAT.PG.1.284362", "52823": "EJAT.CV.6.52823", "53677": "EJAT.CV.1.53677",
    "54239": "EJAT.CV.6.54239", "54293": "EJAT.CV.2.54293", "57777": "EJAT.CV.1.57777",
    "57783": "EJAT.CV.6.57783", "57811": "EJAT.CV.4.57811", "57841": "EJAT.CV.3.57841",
    "57955": "EJAT.FH.1.57955", "160037": "EJAT.PG.1.160037", "175563": "EJAT.PG.1.175563",
    "178169": "EJAT.PG.1.178169", "181253": "EJAT.CH.1.181253", "184191": "EJAT.PG.1.184191",
    "185085": "EJAT.FH.1.185085", "197937": "EJAT.PG.1.197937", "203577": "EJAT.CV.2.203577 (Supersite)",
    "203597": "EJAT.FH.1.203597", "203601": "EJAT.CV.1.203601", "207729": "EJAT.CV.1.207729",
    "211993": "EJAT.CV.3.211993", "218227": "EJAT.PG.1.218227", "218237": "EJAT.PG.1.218237",
    "218273": "EJAT.PG.1.218273"
  };

  const SPODS = [
    { sn: "MOD-00536", name: "QuantAQ MOD-00536 (Mosleys - Cheverly)", lat: 38.920551, lon: -76.91951 },
    { sn: "MOD-00537", name: "QuantAQ MOD-00537 (St. Matthews Church - Turner Station)", lat: 39.243000, lon: -76.512400 },
    { sn: "MOD-00733", name: "QuantAQ MOD-00733 (UMD Lab)", lat: 38.905700, lon: -76.911500 },
    { sn: "MOD-00745", name: "QuantAQ MOD-00745 (Thurmond Jones Residence - Beltsville)", lat: 38.905100, lon: -76.910000 },
    { sn: "MOD-00746", name: "QuantAQ MOD-00746 (MDE 1103246 - North Laurel)", lat: 39.143200, lon: -76.846000 },
    { sn: "MOD-00747", name: "QuantAQ MOD-00747 (Linwood Jackson - Turner Station)", lat: 39.233944, lon: -76.504501 },
    { sn: "MOD-00748", name: "QuantAQ MOD-00748 (Annapolis - Mt. Olive)", lat: 38.969685, lon: -76.542290 },
    { sn: "MOD-00749", name: "QuantAQ MOD-00749 (HU Beltsville)", lat: 39.055400, lon: -76.878800 },
    { sn: "MOD-00760", name: "QuantAQ MOD-00760 (Curtis Bay, MD)", lat: 39.055200, lon: -76.878600 },
    { sn: "MOD-00824", name: "QuantAQ MOD-00824 (CHECD centralized site - Baltimore)", lat: 39.224470, lon: -76.587008 }
  ];

  const CITY_AVG_SENSORS = [14633, 75995, 12595];

  let markerMap = {};
  let markerMeta = {};
  let userMarker = null;

  const map = L.map("map").setView([38.922, -76.915], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const chart = new Chart(document.getElementById("airChart").getContext("2d"), {
    type: "line",
    data: { datasets: [
      { label: "Local Station", data: [], borderColor: "#4477ce", tension: 0.1, fill: true, backgroundColor: "rgba(68, 119, 206, 0.1)" },
      { label: "City Average", data: [], borderColor: "#ff4444", borderDash: [5,5], pointRadius: 0, fill: false }
    ]},
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { x: { type: "time" }, y: { beginAtZero: true, title: { display: true, text: "AQI" } } }
    }
  });

  function getAQIColor(aqi) {
    if (aqi <= 50) return "#00e400";
    if (aqi <= 100) return "#ffff00";
    if (aqi <= 150) return "#ff7e00";
    return "#ff0000";
  }

  function makeSpodIcon(color) {
    return L.divIcon({
      className: "spod-tri",
      html: `
        <div style="
          width:0;height:0;
          border-left:12px solid transparent;
          border-right:12px solid transparent;
          border-bottom:22px solid ${color};
          filter:drop-shadow(0 0 2px #000);
        "></div>
      `,
      iconSize: [24, 24],
      iconAnchor: [12, 22]
    });
  }

  async function proxyGet(params) {
    const url = API_PROXY + "?" + new URLSearchParams(params).toString();
    const res = await fetch(url);
    if (!res.ok) return null;
    return await res.json();
  }

  async function fetchPurpleAirBox() {
    return await proxyGet({ action: "purpleair_box" });
  }

  async function fetchPurpleAirHistory(sensorId, startEpochSeconds) {
    return await proxyGet({ action: "purpleair_history", id: String(sensorId), start: String(startEpochSeconds) });
  }

  function isoDateLocal(d) {
    const yr = d.getFullYear();
    const mo = String(d.getMonth() + 1).padStart(2, "0");
    const da = String(d.getDate()).padStart(2, "0");
    return `${yr}-${mo}-${da}`;
  }

  function safeNum(x) {
    const v = Number(x);
    return Number.isFinite(v) ? v : null;
  }

  function avg(arr) {
    if (!arr || !arr.length) return null;
    const nums = arr.filter(v => Number.isFinite(v));
    if (!nums.length) return null;
    return nums.reduce((a,b)=>a+b,0) / nums.length;
  }

  function aqiFromBreakpoints(C, table) {
    if (C === null || C === undefined) return null;
    const c = Number(C);
    if (!Number.isFinite(c) || c < 0) return null;

    for (const bp of table) {
      if (c >= bp.cLow && c <= bp.cHigh) {
        const I = ((bp.iHigh - bp.iLow) / (bp.cHigh - bp.cLow)) * (c - bp.cLow) + bp.iLow;
        return Math.round(I);
      }
    }
    return null;
  }

  // Breakpoints (your current tables)
  const BP_PM25_24H = [
    { cLow: 0.0,   cHigh: 12.0,   iLow: 0,   iHigh: 50 },
    { cLow: 12.1,  cHigh: 35.4,   iLow: 51,  iHigh: 100 },
    { cLow: 35.5,  cHigh: 55.4,   iLow: 101, iHigh: 150 },
    { cLow: 55.5,  cHigh: 150.4,  iLow: 151, iHigh: 200 },
    { cLow: 150.5, cHigh: 250.4,  iLow: 201, iHigh: 300 },
    { cLow: 250.5, cHigh: 350.4,  iLow: 301, iHigh: 400 },
    { cLow: 350.5, cHigh: 500.4,  iLow: 401, iHigh: 500 }
  ];

  const BP_PM10_24H = [
    { cLow: 0,   cHigh: 54,  iLow: 0,   iHigh: 50 },
    { cLow: 55,  cHigh: 154, iLow: 51,  iHigh: 100 },
    { cLow: 155, cHigh: 254, iLow: 101, iHigh: 150 },
    { cLow: 255, cHigh: 354, iLow: 151, iHigh: 200 },
    { cLow: 355, cHigh: 424, iLow: 201, iHigh: 300 },
    { cLow: 425, cHigh: 504, iLow: 301, iHigh: 400 },
    { cLow: 505, cHigh: 604, iLow: 401, iHigh: 500 }
  ];

  const BP_O3_8H_PPM = [
    { cLow: 0.000, cHigh: 0.054, iLow: 0,   iHigh: 50 },
    { cLow: 0.055, cHigh: 0.070, iLow: 51,  iHigh: 100 },
    { cLow: 0.071, cHigh: 0.085, iLow: 101, iHigh: 150 },
    { cLow: 0.086, cHigh: 0.105, iLow: 151, iHigh: 200 },
    { cLow: 0.106, cHigh: 0.200, iLow: 201, iHigh: 300 }
  ];

  const BP_NO2_1H_PPB = [
    { cLow: 0,    cHigh: 53,   iLow: 0,   iHigh: 50 },
    { cLow: 54,   cHigh: 100,  iLow: 51,  iHigh: 100 },
    { cLow: 101,  cHigh: 360,  iLow: 101, iHigh: 150 },
    { cLow: 361,  cHigh: 649,  iLow: 151, iHigh: 200 },
    { cLow: 650,  cHigh: 1249, iLow: 201, iHigh: 300 },
    { cLow: 1250, cHigh: 1649, iLow: 301, iHigh: 400 },
    { cLow: 1650, cHigh: 2049, iLow: 401, iHigh: 500 }
  ];

  const BP_CO_8H_PPM = [
    { cLow: 0.0,  cHigh: 4.4,  iLow: 0,   iHigh: 50 },
    { cLow: 4.5,  cHigh: 9.4,  iLow: 51,  iHigh: 100 },
    { cLow: 9.5,  cHigh: 12.4, iLow: 101, iHigh: 150 },
    { cLow: 12.5, cHigh: 15.4, iLow: 151, iHigh: 200 },
    { cLow: 15.5, cHigh: 30.4, iLow: 201, iHigh: 300 },
    { cLow: 30.5, cHigh: 40.4, iLow: 301, iHigh: 400 },
    { cLow: 40.5, cHigh: 50.4, iLow: 401, iHigh: 500 }
  ];

  function rollingAverageMax(series, windowHours) {
    const wMs = windowHours * 3600000;
    let best = null;

    for (let i = 0; i < series.length; i++) {
      const tEnd = series[i].t;
      const tStart = tEnd - wMs;
      const vals = [];
      for (let j = i; j >= 0; j--) {
        if (series[j].t < tStart) break;
        if (Number.isFinite(series[j].v)) vals.push(series[j].v);
      }
      const a = avg(vals);
      if (a !== null) best = (best === null) ? a : Math.max(best, a);
    }
    return best;
  }

  function maxVal(series) {
    const vals = series.map(p => p.v).filter(v => Number.isFinite(v));
    if (!vals.length) return null;
    return Math.max(...vals);
  }

  function ceAdderPercent(aqi) {
    if (aqi >= 80 && aqi <= 99) return 0.01;
    if (aqi >= 100 && aqi <= 119) return 0.02;
    if (aqi >= 120) return 0.03;
    return 0;
  }

  function computeCEAQIFromAQIs(aqis) {
    const list = aqis.filter(v => Number.isFinite(v));
    if (!list.length) return 0;

    const base = Math.max(...list);

    let adders = 0;
    for (const aqi of list) {
      if (aqi === base) continue;
      const pct = ceAdderPercent(aqi);
      if (pct > 0) adders += base * pct;
    }

    return Math.round(base + adders);
  }

  async function fetchQuantAQLast24h(sn) {
    const now = new Date();
    const today = isoDateLocal(now);
    const yday = isoDateLocal(new Date(now.getTime() - 86400000));

    const a = await proxyGet({ action: "quantaq_by_date", sn, date: today });
    const b = await proxyGet({ action: "quantaq_by_date", sn, date: yday });

    const rows = [];
    if (b && b.data) rows.push(...b.data);
    if (a && a.data) rows.push(...a.data);

    const cutoff = Date.now() - 86400000;

    return rows
      .map(r => {
        const tRaw = r.timestamp_local || r.timestamp || r.time || r.datetime;
        const t = Date.parse(tRaw);

        const pm25 = safeNum(r.pm25 ?? r.pm2_5 ?? r.pm2_5_atm ?? r["pm2.5"] ?? r["pm2_5"] ?? r["PM2.5"]);
        const o3  = safeNum(r.o3 ?? r.O3 ?? r.ozone ?? r.ozone_ppb);
        const no2 = safeNum(r.no2 ?? r.NO2 ?? r.nitrogen_dioxide ?? r.no2_ppb);
        const co  = safeNum(r.co ?? r.CO ?? r.carbon_monoxide ?? r.co_ppm);
        const pm10 = safeNum(r.pm10 ?? r.PM10);

        return { t, pm25, o3, no2, co, pm10 };
      })
      .filter(p => Number.isFinite(p.t) && p.t >= cutoff)
      .sort((x, y) => x.t - y.t);
  }

  function computeCurrentAQI_FromPM(pm25) {
    const aqi = aqiFromBreakpoints(pm25, BP_PM25_24H);
    return aqi === null ? 0 : aqi;
  }

  function computeCEAQI_ForPurpleAir(historyRows) {
    const pmSeries = historyRows.map(r => safeNum(r[1])).filter(v => v !== null);
    const pm24 = avg(pmSeries);
    const aqiPm24 = aqiFromBreakpoints(pm24, BP_PM25_24H);
    if (aqiPm24 === null) return 0;
    return computeCEAQIFromAQIs([aqiPm24]);
  }

  function computeCEAQI_ForQuantAQ(series) {
    const pm25Series = series.map(p => ({ t: p.t, v: p.pm25 })).filter(p => p.v !== null);
    const o3Series   = series.map(p => ({ t: p.t, v: p.o3  })).filter(p => p.v !== null);
    const no2Series  = series.map(p => ({ t: p.t, v: p.no2 })).filter(p => p.v !== null);
    const coSeries   = series.map(p => ({ t: p.t, v: p.co  })).filter(p => p.v !== null);
    const pm10Series = series.map(p => ({ t: p.t, v: p.pm10 })).filter(p => p.v !== null);

    const pm25_24 = avg(pm25Series.map(p => p.v));
    const aqi_pm25_24 = aqiFromBreakpoints(pm25_24, BP_PM25_24H);

    const o3_8h_max_ppb = rollingAverageMax(o3Series, 8);
    const o3_8h_max_ppm = (o3_8h_max_ppb === null) ? null : (o3_8h_max_ppb / 1000.0);
    const aqi_o3_8h = aqiFromBreakpoints(o3_8h_max_ppm, BP_O3_8H_PPM);

    const no2_1h_max_ppb = maxVal(no2Series);
    const aqi_no2_1h = aqiFromBreakpoints(no2_1h_max_ppb, BP_NO2_1H_PPB);

    const co_8h_max_ppm = rollingAverageMax(coSeries, 8);
    const aqi_co_8h = aqiFromBreakpoints(co_8h_max_ppm, BP_CO_8H_PPM);

    const pm10_24 = avg(pm10Series.map(p => p.v));
    const aqi_pm10_24 = aqiFromBreakpoints(pm10_24, BP_PM10_24H);

    const aqis = [aqi_pm25_24, aqi_o3_8h, aqi_no2_1h, aqi_co_8h, aqi_pm10_24].filter(v => v !== null);

    if (!aqis.length) return 0;
    return computeCEAQIFromAQIs(aqis);
  }

  function computeAQITimeSeriesForPlot_FromPM(seriesPoints) {
    return (seriesPoints || []).map(p => ({ x: p.t, y: computeCurrentAQI_FromPM(p.pm25) }));
  }

  function setLeftPanel(name, currentAQI, ce24) {
    document.getElementById("statName").innerText = name || "--";

    document.getElementById("statAQI").innerText = String(currentAQI ?? "--");
    document.getElementById("statAQI").style.color = getAQIColor(Number(currentAQI) || 0);

    document.getElementById("statCE").innerText = String(ce24 ?? "--");
    document.getElementById("statCE").style.color = getAQIColor(Number(ce24) || 0);
  }

  function setMarkerStyle(id, type, ce24) {
    const color = getAQIColor(Number(ce24) || 0);

    const m = markerMap[id];
    if (!m) return;

    if (type === "quantaq") {
      m.setIcon(makeSpodIcon(color));
    } else {
      // circleMarker style update
      m.setStyle({
        fillColor: color,
        color: "#000",
        weight: 2,
        fillOpacity: 0.9
      });
    }
  }

  function setTooltip(id) {
    const meta = markerMeta[id];
    const m = markerMap[id];
    if (!meta || !m) return;

    const name = meta.name || id;
    const cur = Number(meta.lastCurrent) || 0;
    const ce = Number(meta.lastCE) || 0;

    m.bindTooltip(`<b>${name}</b><br>Current AQI: ${cur}<br>24h CE AQI: ${ce}`);
  }

  function handleDropdownChange(id) {
    if (!markerMap[id]) return;
    map.flyTo(markerMap[id].getLatLng(), 15);
    updateDisplay(id);
  }

  async function updateDisplay(id) {
    const start = Math.floor(Date.now() / 1000) - 86400;

    // QuantAQ
    if (id.startsWith("MOD-")) {
      const metaRow = SPODS.find(s => s.sn === id);
      const name = metaRow ? metaRow.name : id;

      const series = await fetchQuantAQLast24h(id);

      const latest = series.length ? series[series.length - 1] : null;
      const currentAQI = latest ? computeCurrentAQI_FromPM(latest.pm25) : 0;
      const ce24 = computeCEAQI_ForQuantAQ(series);

      markerMeta[id] = { type: "quantaq", name, lastCurrent: currentAQI, lastCE: ce24 };
      setLeftPanel(name, currentAQI, ce24);

      // Color marker by CE AQI
      setMarkerStyle(id, "quantaq", ce24);
      setTooltip(id);

      chart.data.datasets[0].data = computeAQITimeSeriesForPlot_FromPM(series);
      chart.update();
      return;
    }

    // PurpleAir
    const json = await fetchPurpleAirHistory(id, start);
    if (json && json.data) {
      const rows = json.data.sort((a,b)=>a[0]-b[0]);
      const latestRow = rows.length ? rows[rows.length - 1] : null;

      const pmNow = latestRow ? safeNum(latestRow[1]) : null;
      const currentAQI = computeCurrentAQI_FromPM(pmNow);
      const ce24 = computeCEAQI_ForPurpleAir(rows);

      const name = SENSORS[id] || "Unknown Station";

      markerMeta[id] = { type: "purpleair", name, lastCurrent: currentAQI, lastCE: ce24 };
      setLeftPanel(name, currentAQI, ce24);

      // Color marker by CE AQI
      setMarkerStyle(id, "purpleair", ce24);
      setTooltip(id);

      chart.data.datasets[0].data = rows.map(r => ({ x: r[0]*1000, y: computeCurrentAQI_FromPM(safeNum(r[1])) }));
      chart.update();
    }
  }

  async function loadCityAvg() {
    let combined = {};
    for (const id of CITY_AVG_SENSORS) {
      const start = Math.floor(Date.now() / 1000) - 86400;
      const json = await fetchPurpleAirHistory(String(id), start);
      if (json && json.data) {
        json.data.forEach(r => {
          const t = Math.round(r[0] / 3600) * 3600000;
          if (!combined[t]) combined[t] = [];
          const aqi = computeCurrentAQI_FromPM(safeNum(r[1]));
          combined[t].push(aqi);
        });
      }
    }

    chart.data.datasets[1].data = Object.keys(combined)
      .map(t => {
        const arr = combined[t];
        const avgVal = arr.reduce((a, b) => a + b, 0) / arr.length;
        return { x: parseInt(t, 10), y: avgVal };
      })
      .sort((a, b) => a.x - b.x);

    chart.update();
  }

  document.getElementById("locateBtn").addEventListener("click", async () => {
    const query = document.getElementById("addrInput").value;
    if (!query) return;

    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", Cheverly, MD")}`;

    try {
      const response = await fetch(url);
      const results = await response.json();
      if (!results.length) return;

      const lat = Number(results[0].lat);
      const lon = Number(results[0].lon);
      const userLoc = L.latLng(lat, lon);

      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat, lon]).addTo(map).bindPopup("Your Location").openPopup();

      map.flyTo(userLoc, 15);

      let nearestId = null;
      let minDist = Infinity;

      Object.keys(markerMap).forEach(id => {
        const dist = userLoc.distanceTo(markerMap[id].getLatLng());
        if (dist < minDist) { minDist = dist; nearestId = id; }
      });

      if (nearestId) {
        document.getElementById("devSel").value = nearestId;
        handleDropdownChange(nearestId);
      }
    } catch (e) {
      console.error(e);
    }
  });

  async function init() {
    const sel = document.getElementById("devSel");

    // QuantAQ first: compute both values and color by CE AQI
    for (const s of SPODS) {
      let currentAQI = 0;
      let ce24 = 0;

      try {
        const series = await fetchQuantAQLast24h(s.sn);
        const latest = series.length ? series[series.length - 1] : null;
        currentAQI = latest ? computeCurrentAQI_FromPM(latest.pm25) : 0;
        ce24 = computeCEAQI_ForQuantAQ(series);
      } catch (e) {}

      const m = L.marker([s.lat, s.lon], { icon: makeSpodIcon(getAQIColor(ce24)) }).addTo(map);
      markerMap[s.sn] = m;
      markerMeta[s.sn] = { type: "quantaq", name: s.name, lastCurrent: currentAQI, lastCE: ce24 };

      sel.add(new Option(s.name, s.sn));
      setTooltip(s.sn);

      m.on("click", () => { sel.value = s.sn; handleDropdownChange(s.sn); });
    }

    const json = await fetchPurpleAirBox();
    if (json && json.data) {
      for (const r of json.data) {
        const id = String(r[0]);
        if (!SENSORS[id]) continue;

        const name = SENSORS[id];
        const pmNow = safeNum(r[3]);
        const currentAQI = computeCurrentAQI_FromPM(pmNow);

        const m = L.circleMarker([r[1], r[2]], {
          radius: 11,
          fillColor: "#999",
          color: "#000",
          weight: 2,
          fillOpacity: 0.9
        }).addTo(map);

        markerMap[id] = m;
        markerMeta[id] = { type: "purpleair", name, lastCurrent: currentAQI, lastCE: 0 };

        sel.add(new Option(name, id));
        setTooltip(id);

        m.on("click", () => { sel.value = id; handleDropdownChange(id); });

        // Compute CE AQI from history once so hover and color both work
        try {
          const start = Math.floor(Date.now() / 1000) - 86400;
          const hist = await fetchPurpleAirHistory(id, start);
          if (hist && hist.data) {
            const rows = hist.data.sort((a,b)=>a[0]-b[0]);
            const ce24 = computeCEAQI_ForPurpleAir(rows);

            markerMeta[id].lastCE = ce24;

            // Color by CE AQI and refresh tooltip
            setMarkerStyle(id, "purpleair", ce24);
            setTooltip(id);
          }
        } catch (e) {
          // leave defaults if it fails
        }
      }
    }

    await loadCityAvg();

    sel.value = "203577";
    handleDropdownChange("203577");
  }

  init();
</script>
</body>
</html>
