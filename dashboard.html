<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EJAT Network Dashboard</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  
  <style>
    :root { --navy: #1a305e; --blue: #4477ce; }
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; }
    header { background: var(--navy); color: white; padding: 15px 25px; height: 60px; box-sizing: border-box; display: flex; align-items: center; justify-content: space-between; }
    #container { display: flex; height: calc(100vh - 60px); }
    
    /* Sidebar */
    #sidebar { width: 350px; background: #f4f4f4; border-right: 1px solid #ccc; padding: 15px; overflow-y: auto; }
    .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; }
    label { font-size: 11px; font-weight: bold; color: #666; text-transform: uppercase; }
    select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; }
    
    /* Stats */
    .aqi-display { text-align: center; margin-top: 10px; }
    #statAQI { font-size: 60px; font-weight: 900; line-height: 1; text-shadow: 1px 1px 0 #000; }
    #statCE { font-size: 32px; font-weight: 700; margin-top: 10px; }
    
    /* Main Content */
    #main { flex: 1; display: flex; flex-direction: column; }
    #map { height: 50%; width: 100%; }
    #chart-container { height: 50%; width: 100%; padding: 10px; box-sizing: border-box; background: white; }
    
    /* Marker Styles */
    .tri-marker { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 18px solid #999; filter: drop-shadow(0 0 1px #000); }
  </style>
</head>
<body>

<header>
  <div style="font-weight:bold; font-size:1.2rem;">Cheverly Air Quality Network</div>
</header>

<div id="container">
  <aside id="sidebar">
    <div class="card">
      <label>Select Station</label>
      <select id="devSel"></select>
    </div>
    <div class="card aqi-display">
      <div id="statName" style="font-weight:bold; font-size: 14px; margin-bottom:10px;">Select a Station</div>
      <label>Current AQI</label>
      <div id="statAQI" style="color:#999;">--</div>
      <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
      <label>24hr Average</label>
      <div id="statCE" style="color:#999;">--</div>
    </div>
  </aside>

  <main id="main">
    <div id="map"></div>
    <div id="chart-container">
      <canvas id="airChart"></canvas>
    </div>
  </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<script>
  // 1. DATA CONFIG
  const PA_SENSORS = { "284362": "EJAT.PG.1.284362", "52823": "EJAT.CV.6.52823", "53677": "EJAT.CV.1.53677", "54239": "EJAT.CV.6.54239", "54293": "EJAT.CV.2.54293", "57777": "EJAT.CV.1.57777", "57783": "EJAT.CV.6.57783", "57811": "EJAT.CV.4.57811", "57841": "EJAT.CV.3.57841", "57955": "EJAT.FH.1.57955", "160037": "EJAT.PG.1.160037", "175563": "EJAT.PG.1.175563", "178169": "EJAT.PG.1.178169", "181253": "EJAT.CH.1.181253", "184191": "EJAT.PG.1.184191", "185085": "EJAT.FH.1.185085", "197937": "EJAT.PG.1.197937", "203577": "EJAT.CV.2.203577 (Supersite)", "203597": "EJAT.FH.1.203597", "203601": "EJAT.CV.1.203601", "207729": "EJAT.CV.1.207729", "211993": "EJAT.CV.3.211993", "218227": "EJAT.PG.1.218227", "218237": "EJAT.PG.1.218237", "218273": "EJAT.PG.1.218273" };
  
  const TRI_STATIONS = [
    { id: "MOD-00536", name: "QuantAQ: Mosleys", lat: 38.920551, lon: -76.91951, type: "quantaq" },
    { id: "MOD-00537", name: "QuantAQ: St. Matthews Church", lat: 39.243, lon: -76.5124, type: "quantaq" },
    { id: "MOD-00733", name: "QuantAQ: UMD Lab", lat: 38.9057, lon: -76.9115, type: "quantaq" },
    { id: "MOD-00745", name: "QuantAQ: Thurmond Jones", lat: 38.9051, lon: -76.91, type: "quantaq" },
    { id: "MOD-00746", name: "QuantAQ: North Laurel", lat: 39.1432, lon: -76.846, type: "quantaq" },
    { id: "MOD-00747", name: "QuantAQ: Linwood Jackson", lat: 39.233944, lon: -76.504501, type: "quantaq" },
    { id: "MOD-00748", name: "QuantAQ: Annapolis", lat: 38.969685, lon: -76.54229, type: "quantaq" },
    { id: "MOD-00749", name: "QuantAQ: HU Beltsville", lat: 39.0554, lon: -76.8788, type: "quantaq" },
    { id: "MOD-00760", name: "QuantAQ: Curtis Bay", lat: 39.0552, lon: -76.8786, type: "quantaq" },
    { id: "MOD-00824", name: "QuantAQ: CHECD Baltimore", lat: 39.22447, lon: -76.587008, type: "quantaq" },
    { id: "D14781", name: "C12: Sector A", lat: 38.92054, lon: -76.919716, type: "c12" },
    { id: "D14645", name: "C12: NW Boundary A", lat: 38.991268, lon: -76.943237, type: "c12" },
    { id: "D17615", name: "C12: SE Border", lat: 38.908325, lon: -76.899002, type: "c12" },
    { id: "E10588", name: "C12: NW Boundary B", lat: 38.991806, lon: -76.94313, type: "c12" },
    { id: "D14646", name: "C12: Standalone NW", lat: 38.989586, lon: -76.940407, type: "c12" }
  ];

  let markerMap = {}, metaMap = {};

  // 2. SETUP MAP
  const map = L.map('map').setView([38.922, -76.915], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  // 3. SETUP CHART
  const ctx = document.getElementById('airChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: { datasets: [{ label: 'AQI Over Time', data: [], borderColor: '#4477ce', fill: false }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time' } } }
  });

  // 4. HELPERS
  function aqiFromPM(pm) {
    if (pm === undefined || pm === null || pm < 0) return 0;
    if (pm <= 12) return Math.round(50/12 * pm);
    if (pm <= 35.4) return Math.round(((100-51)/(35.4-12.1))*(pm-12.1)+51);
    if (pm <= 55.4) return Math.round(((150-101)/(55.4-35.5))*(pm-35.5)+101);
    return Math.round(((200-151)/(150.4-55.5))*(pm-55.5)+151);
  }

  function getColor(aqi) {
    if (aqi <= 50) return "#00e400";
    if (aqi <= 100) return "#ffff00";
    if (aqi <= 150) return "#ff7e00";
    return "#ff0000";
  }

  async function update(id) {
    const meta = metaMap[id];
    let current = 0, avg = 0, history = [];

    const url = `/api/aq?action=${meta.type === 'quantaq' ? 'quantaq_history' : (meta.type === 'purpleair' ? 'purpleair_history' : 'grove_history')}&id=${id}&compId=${id}&start=${Math.floor(Date.now()/1000)-86400}`;
    
    try {
      const res = await fetch(url);
      const data = await res.json();
      
      if (meta.type === 'purpleair') {
        const rows = data.data || [];
        if (rows.length > 0) {
          current = aqiFromPM(rows[0][1]);
          avg = aqiFromPM(rows.reduce((a,b)=>a+b[1],0)/rows.length);
          history = rows.map(r => ({ x: r[0]*1000, y: aqiFromPM(r[1]) }));
        }
      } else {
        // QuantAQ or C12
        if (Array.isArray(data) && data.length > 0) {
          const latest = data[0].pm25 || data[0].data || 0;
          current = aqiFromPM(latest);
          avg = aqiFromPM(data.reduce((a,b)=>a+(b.pm25 || b.data || 0),0)/data.length);
          history = data.map(d => ({ x: d.time, y: aqiFromPM(d.pm25 || d.data) }));
        }
      }
    } catch (e) { console.error(e); }

    document.getElementById('statName').innerText = meta.name;
    document.getElementById('statAQI').innerText = current;
    document.getElementById('statAQI').style.color = getColor(current);
    document.getElementById('statCE').innerText = avg;
    document.getElementById('statCE').style.color = getColor(avg);
    chart.data.datasets[0].data = history;
    chart.update();
  }

  // 5. INIT
  async function init() {
    const sel = document.getElementById('devSel');

    // Load Triangles
    TRI_STATIONS.forEach(s => {
      const icon = L.divIcon({ className: 'custom-tri', html: `<div class="tri-marker" id="tri-${s.id}"></div>`, iconAnchor: [10, 18] });
      const m = L.marker([s.lat, s.lon], { icon }).addTo(map);
      m.bindTooltip(`<b>${s.name}</b>`);
      m.on('click', () => { sel.value = s.id; update(s.id); });
      markerMap[s.id] = m;
      metaMap[s.id] = s;
      sel.add(new Option(s.name, s.id));
    });

    // Load PurpleAir
    try {
      const res = await fetch('/api/aq?action=purpleair_box');
      const json = await res.json();
      json.data.forEach(r => {
        const id = String(r[0]);
        if (PA_SENSORS[id]) {
          const m = L.circleMarker([r[1], r[2]], { radius: 10, color: '#000', fillColor: '#999', fillOpacity: 0.8 }).addTo(map);
          m.bindTooltip(`<b>${PA_SENSORS[id]}</b>`);
          m.on('click', () => { sel.value = id; update(id); });
          markerMap[id] = m;
          metaMap[id] = { name: PA_SENSORS[id], type: 'purpleair' };
          sel.add(new Option(PA_SENSORS[id], id));
        }
      });
    } catch(e) {}

    sel.onchange = (e) => { 
      const id = e.target.value;
      map.flyTo(markerMap[id].getLatLng(), 13);
      update(id);
    };

    // Default selection
    sel.value = "203577";
    update("203577");
  }

  init();
</script>
</body>
</html>
