<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EJAT Air Quality Network</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/bundle.min.js"></script>
  
  <style>
    :root { --navy: #1a305e; --blue: #4477ce; --light: #f4f7f9; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    
    /* Page Navigator / Top Bar */
    .navbar { background: var(--navy); color: white; display: flex; align-items: center; padding: 0 20px; height: 50px; justify-content: space-between; }
    .nav-links { display: flex; gap: 20px; }
    .nav-item { cursor: pointer; opacity: 0.8; font-weight: bold; text-decoration: none; color: white; font-size: 0.9rem; }
    .nav-item:hover, .nav-item.active { opacity: 1; border-bottom: 2px solid white; }

    #layout { display: flex; flex: 1; overflow: hidden; }
    
    /* Sidebar */
    #sidebar { width: 350px; background: var(--light); border-right: 1px solid #ccc; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    .card { background: white; border-radius: 8px; padding: 15px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    
    /* Stats & Legend */
    .stat-box { text-align: center; }
    .big-num { font-size: 3rem; font-weight: 900; line-height: 1; margin: 10px 0; }
    .legend-row { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; margin-bottom: 4px; font-weight: bold; }
    .color-box { width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(0,0,0,0.1); }

    /* Main View */
    #main { flex: 1; position: relative; }
    #map { height: 100%; width: 100%; }

    /* Hover Tooltip Styling */
    .leaflet-tooltip-own { background: white; border: 2px solid var(--navy); border-radius: 4px; padding: 5px 10px; font-weight: bold; font-size: 14px; }
  </style>
</head>
<body>

  <nav class="navbar">
    <div style="font-weight: bold;">EJAT NETWORK</div>
    <div class="nav-links">
      <a class="nav-item active">MAP VIEW</a>
      <a class="nav-item">STATION LIST</a>
      <a class="nav-item">ABOUT</a>
    </div>
    <div id="netAvgBox" style="font-size: 0.8rem; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px;">
      DC Area Avg: <span id="dcAvg" style="font-weight:bold;">--</span> AQI
    </div>
  </nav>

  <div id="layout">
    <aside id="sidebar">
      <div class="card">
        <label style="font-size: 0.7rem; color: #666; font-weight: bold; text-transform: uppercase;">Station Selection</label>
        <input type="text" id="stationSearch" placeholder="Filter sensors..." style="width:100%; padding:8px; margin-top:8px; border:1px solid #ccc; border-radius:4px;">
        <select id="devSel" style="width:100%; padding:8px; margin-top:8px;"></select>
      </div>

      <div class="card stat-box">
        <div id="statName" style="font-weight: bold; color: var(--navy);">Select a Sensor</div>
        <div id="statAQI" class="big-num" style="color: #ccc;">--</div>
        <div style="font-size: 0.7rem; font-weight: bold; color: #888;">CURRENT AQI</div>
      </div>

      <div class="card">
        <label style="font-size: 0.7rem; color: #666; font-weight: bold; text-transform: uppercase;">AQI Range Key</label>
        <div style="margin-top:10px;">
          <div class="legend-row"><div class="color-box" style="background:#00e400;"></div> 0 - 50 Good</div>
          <div class="legend-row"><div class="color-box" style="background:#ffff00;"></div> 51 - 100 Moderate</div>
          <div class="legend-row"><div class="color-box" style="background:#ff7e00;"></div> 101 - 150 Sensitive</div>
          <div class="legend-row"><div class="color-box" style="background:#ff0000;"></div> 151+ Unhealthy</div>
        </div>
      </div>
    </aside>

    <main id="main">
      <div id="map"></div>
    </main>
  </div>

  <script>
    const map = L.map('map').setView([38.922, -76.915], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // ADDRESS SEARCH FEATURE
    const searchControl = new GeoSearch.GeoSearchControl({
      provider: new GeoSearch.OpenStreetMapProvider(),
      style: 'bar',
      showMarker: true,
      retainZoomLevel: false,
      autoClose: true,
      keepResult: true
    });
    map.addControl(searchControl);

    function getAQIColor(aqi) {
      if (!aqi || aqi === 0) return "#ccc";
      if (aqi <= 50) return "#00e400";
      if (aqi <= 100) return "#ffff00";
      if (aqi <= 150) return "#ff7e00";
      return "#ff0000";
    }

    // SIMULATED DATA FOR HOVER (Until Vercel reset)
    const stations = [
      { id: "203577", name: "EJAT.CV.2.203577 (Supersite)", lat: 38.922, lon: -76.915, aqi: 42 },
      { id: "57841", name: "EJAT.CV.3.57841", lat: 38.930, lon: -76.925, aqi: 65 }
    ];

    let totalAQI = 0;
    stations.forEach(s => {
      const color = getAQIColor(s.aqi);
      const marker = L.circleMarker([s.lat, s.lon], {
        radius: 12, fillColor: color, color: "#000", weight: 2, fillOpacity: 0.9
      }).addTo(map);

      // HOVER DATA (Tooltip)
      marker.bindTooltip(`<b>${s.name}</b><br>AQI: ${s.aqi}`, {
        className: 'leaflet-tooltip-own',
        direction: 'top',
        offset: [0, -10]
      });

      // CLICK TO UPDATE SIDEBAR
      marker.on('click', () => {
        document.getElementById('statName').innerText = s.name;
        document.getElementById('statAQI').innerText = s.aqi;
        document.getElementById('statAQI').style.color = color;
      });

      totalAQI += s.aqi;
    });

    // DC AREA AVERAGE
    document.getElementById('dcAvg').innerText = Math.round(totalAQI / stations.length);

  </script>
</body>
</html>
