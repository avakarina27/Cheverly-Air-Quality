<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cheverly Air Quality</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --brand-navy: #1a305e;
      --search-blue: #4477ce;
      --orange: #f59e0b;
    }

    html, body { margin: 0; padding: 0; height: 100%; width: 100%; font-family: "Segoe UI", Tahoma, sans-serif; }
    .topbar {
      background: var(--brand-navy); color: white;
      padding: 0 25px; display: flex; justify-content: space-between;
      align-items: center; height: 60px; box-sizing: border-box;
    }
    .brand { font-size: 1.2rem; font-weight: bold; }
    .nav a { color: white; text-decoration: none; margin-left: 20px; font-size: 0.9rem; opacity: 0.85; }
    .nav a:hover { opacity: 1; text-decoration: underline; }

    #layout { display: flex; height: calc(100vh - 60px); width: 100vw; }

    #sidebar {
      width: 380px; min-width: 380px;
      background: #f4f6f8; border-right: 1px solid #ddd;
      padding: 15px; overflow-y: auto; box-sizing: border-box;
    }

    .card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 12px; }
    label { font-size: 0.7rem; font-weight: bold; color: #666; text-transform: uppercase; margin-bottom: 5px; display: block; }
    select { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }

    #main-content { flex: 1; display: flex; flex-direction: column; height: 100%; }
    #map { height: 100%; width: 100%; }

    .legend-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.85rem; font-weight: 600; color: #333; }
    .dot {
      width: 18px; height: 18px; border-radius: 50%;
      margin-right: 12px; border: 2px solid #000;
      display: inline-block;
    }
    .tri {
      width: 0; height: 0;
      border-left: 10px solid transparent; border-right: 10px solid transparent;
      border-bottom: 18px solid var(--orange);
      margin-right: 12px; filter: drop-shadow(0px 0px 1px #000);
    }
  </style>
</head>

<body>
<header class="topbar">
  <div class="brand">Cheverly Air Quality</div>
  <nav class="nav">
    <a href="index.html">Home</a>
    <a href="dashboard.html" style="font-weight:bold; opacity:1;">Dashboard</a>
    <a href="writeup.html">Community Insights</a>
  </nav>
</header>

<div id="layout">
  <aside id="sidebar">
    <div class="card">
      <label>Station Index</label>
      <select id="devSel"></select>
      <div id="status" style="margin-top:10px; color:#555; font-size:0.85rem;">Loading…</div>
    </div>

    <div class="card">
      <label>Network Legend</label>
      <div class="legend-item"><span class="dot" style="background-color:#4477ce;"></span> PurpleAir (circle)</div>
      <div class="legend-item"><span class="tri"></span> QuantAQ Modulair (triangle)</div>
    </div>
  </aside>

  <div id="main-content">
    <div id="map"></div>
  </div>
</div>

<script>
  const API = "/api/aq";

  // Your PurpleAir IDs (only these will be displayed from the box query)
  const SENSORS = {
    "284362": "EJAT.PG.1.284362", "52823": "EJAT.CV.6.52823", "53677": "EJAT.CV.1.53677",
    "54239": "EJAT.CV.6.54239", "54293": "EJAT.CV.2.54293", "57777": "EJAT.CV.1.57777",
    "57783": "EJAT.CV.6.57783", "57811": "EJAT.CV.4.57811", "57841": "EJAT.CV.3.57841",
    "57955": "EJAT.FH.1.57955", "160037": "EJAT.PG.1.160037", "175563": "EJAT.PG.1.175563",
    "178169": "EJAT.PG.1.178169", "181253": "EJAT.CH.1.181253", "184191": "EJAT.PG.1.184191",
    "185085": "EJAT.FH.1.185085", "197937": "EJAT.PG.1.197937", "203577": "EJAT.CV.2.203577 (Supersite)",
    "203597": "EJAT.FH.1.203597", "203601": "EJAT.CV.1.203601", "207729": "EJAT.CV.1.207729",
    "211993": "EJAT.CV.3.211993", "218227": "EJAT.PG.1.218227", "218237": "EJAT.PG.1.218237",
    "218273": "EJAT.PG.1.218273"
  };

  const map = L.map('map').setView([38.922, -76.915], 14);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  const sel = document.getElementById("devSel");
  const statusEl = document.getElementById("status");
  const markerMap = {};

  function triIcon(color) {
    return L.divIcon({
      className: 'qa-tri',
      html: `<div style="width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:22px solid ${color};filter:drop-shadow(0 0 2px #000);"></div>`,
      iconSize: [24, 24],
      iconAnchor: [12, 22]
    });
  }

  async function apiGet(url) {
    const r = await fetch(url);
    const text = await r.text();
    let parsed;
    try { parsed = JSON.parse(text); } catch { parsed = text; }

    if (!r.ok) {
      console.error("API error", r.status, url, parsed);
      return null;
    }
    return parsed;
  }

  function addOption(label, value) {
    sel.add(new Option(label, value));
  }

  function focusMarker(key) {
    const m = markerMap[key];
    if (!m) return;
    const ll = m.getLatLng ? m.getLatLng() : m.getLatLng?.();
    if (ll) map.flyTo(ll, 15);
    if (m.openPopup) m.openPopup();
  }

  sel.addEventListener("change", () => focusMarker(sel.value));

  async function loadPurpleAir() {
    statusEl.textContent = "Loading PurpleAir…";

    const url = `${API}?action=purpleair_box&nwlng=-77.15&nwlat=39.05&selng=-76.75&selat=38.75&fields=sensor_index,latitude,longitude`;
    const json = await apiGet(url);

    if (!json || !json.data) {
      statusEl.textContent = "PurpleAir failed (check PURPLE_AIR_KEY in Vercel).";
      return;
    }

    let count = 0;
    for (const row of json.data) {
      const id = String(row[0]);
      const lat = row[1];
      const lon = row[2];
      if (!SENSORS[id]) continue;

      const m = L.circleMarker([lat, lon], {
        radius: 10,
        fillColor: "#4477ce",
        color: "#000",
        weight: 2,
        fillOpacity: 0.85
      }).addTo(map);

      m.bindPopup(`<b>${SENSORS[id]}</b><br>PurpleAir ${id}`);
      markerMap[id] = m;

      m.on("click", () => {
        sel.value = id;
      });

      addOption(SENSORS[id], id);
      count++;
    }

    statusEl.textContent = `PurpleAir loaded: ${count} stations`;
  }

  async function loadQuantAQ() {
    statusEl.textContent = statusEl.textContent + " | Loading QuantAQ…";

    const json = await apiGet(`${API}?action=quantaq_devices`);
    if (!json || !Array.isArray(json.data)) {
      statusEl.textContent = statusEl.textContent + " | QuantAQ failed (check QUANTAQ_KEY).";
      return;
    }

    const devices = json.data
      .filter(d => d.status === "ACTIVE" && d.outdoors && d.geo?.lat && d.geo?.lon && d.sn);

    let count = 0;
    for (const d of devices) {
      const key = `QA:${d.sn}`;
      const label = `QuantAQ ${d.sn} (${d.description || d.city || "site"})`;

      const m = L.marker([d.geo.lat, d.geo.lon], { icon: triIcon("#f59e0b") }).addTo(map);
      m.bindPopup(`<b>${label}</b>`);
      markerMap[key] = m;

      m.on("click", () => {
        sel.value = key;
      });

      addOption(label, key);
      count++;
    }

    statusEl.textContent = statusEl.textContent + ` | QuantAQ loaded: ${count} devices`;
  }

  async function init() {
    sel.innerHTML = "";
    addOption("Select a station…", "");

    await loadPurpleAir();   // always try to load
    await loadQuantAQ();     // then try QuantAQ

    // Auto focus first real option if present
    if (sel.options.length > 1) {
      sel.selectedIndex = 1;
      focusMarker(sel.value);
    }
  }

  init();
</script>

</body>
</html>
