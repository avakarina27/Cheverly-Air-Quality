<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EJAT Cheverly | C-12 Real-Time Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        #map { height: 600px; width: 100%; border-radius: 8px; border: 2px solid #1a305e; }
        .c12-popup { font-family: sans-serif; line-height: 1.4; }
        .aqi-badge { background: #ff7e00; color: white; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Cheverly C-12 Deployment Map</h2>
    <div id="map"></div>

<script>
// --- Vercel Environment Access ---
const API_KEY = "40685f12-d3e5-316e-a274-e0a628c20c97"; // Use NEXT_PUBLIC_GS_API_KEY in Vercel settings

// --- C-12 Sensor Mapping ---
const STATIONS = [
    { id: "D14781", name: "C12: Sector A", lat: 38.92054,  lng: -76.919716, gsUid: "8381ec0e-6815-3066-8a89-ea93e13f6a57" },
    { id: "D14645", name: "C12: NW Boundary A", lat: 38.991268, lng: -76.943237, gsUid: "UID_HERE" },
    { id: "D17615", name: "C12: SE Border",     lat: 38.908325, lng: -76.899002, gsUid: "UID_HERE" },
    { id: "E10588", name: "C12: NW Boundary B", lat: 38.991806, lng: -76.943130, gsUid: "UID_HERE" },
    { id: "D14646", name: "C12: Standalone NW", lat: 38.989586, lng: -76.940407, gsUid: "UID_HERE" }
];

const map = L.map('map').setView([38.94, -76.92], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Custom Black Carbon Icon (C-12)
const c12Icon = L.divIcon({
    className: 'custom-div-icon',
    html: "<div style='background-color:#1a305e; width:12px; height:12px; border:2px solid white; border-radius:2px;'></div>",
    iconSize: [15, 15],
    iconAnchor: [7, 7]
});

// --- Fetch & Render Logic ---
async function loadStationData(station) {
    const url = `https://grovestreams.com/api/comp/${station.gsUid}/last_value?api_key=${API_KEY}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        // C-12 usually reports 'BC' (Black Carbon)
        const bcValue = data.find(s => s.id === 'BC')?.val || "No Data";
        
        L.marker([station.lat, station.lng], {icon: c12Icon}).addTo(map)
         .bindPopup(`
            <div class="c12-popup">
                <b>${station.name}</b><br>
                Sensor ID: ${station.id}<br>
                <hr>
                <b>Real-Time BC:</b> ${bcValue} ng/mÂ³<br>
                <small>Updated via GroveStreams Cloud</small>
            </div>
         `);
    } catch (e) {
        // Fallback marker if API fails
        L.marker([station.lat, station.lng], {icon: c12Icon}).addTo(map).bindPopup(`<b>${station.name}</b><br>Cloud offline`);
    }
}

STATIONS.forEach(loadStationData);
</script>
</body>
</html>
