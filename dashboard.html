<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EJAT Air Quality Network</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    :root { --brand-navy: #1a305e; --search-blue: #4477ce; }
    body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; }
    .topbar { background: var(--brand-navy); color: white; padding: 15px; font-weight: bold; }
    #layout { display: flex; flex: 1; overflow: hidden; }
    #sidebar { width: 350px; background: #f4f4f4; border-right: 1px solid #ddd; padding: 15px; overflow-y: auto; }
    #main { flex: 1; display: flex; flex-direction: column; }
    #map { height: 50%; border-bottom: 1px solid #ddd; }
    #chart-box { height: 50%; padding: 10px; box-sizing: border-box; }
    .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; text-align: center; }
    .aqi-val { font-size: 60px; font-weight: 900; }
    .tri { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 20px solid #999; display: inline-block; margin-right: 10px; }
  </style>
</head>
<body>

<div class="topbar">EJAT Air Quality Network</div>

<div id="layout">
  <aside id="sidebar">
    <div class="card">
      <label>Station Index</label>
      <select id="devSel" style="width:100%; padding:8px;" onchange="handleDropdownChange(this.value)"></select>
    </div>
    <div class="card">
      <div id="statName" style="font-weight:bold; margin-bottom:10px;">Select a Station</div>
      <div id="statAQI" class="aqi-val" style="color:#ccc;">--</div>
      <div style="font-size:0.8rem; color:#666;">CURRENT AQI</div>
      <div id="statCE" class="aqi-val" style="color:#ccc; font-size: 40px;">--</div>
      <div style="font-size:0.8rem; color:#666;">24HR AVG AQI</div>
    </div>
  </aside>
  <div id="main">
    <div id="map"></div>
    <div id="chart-box"><canvas id="airChart"></canvas></div>
  </div>
</div>

<script>
  // MATCHING YOUR FILE PATH
  const API_PROXY = "api/aq.js"; 

  const SENSORS = { "203577": "EJAT.CV.2.203577 (Supersite)", "284362": "EJAT.PG.1.284362" };
  const C12_STATIONS = [
    { id: "D14781", name: "C12: Sector A", lat: 38.92054, lon: -76.919716 },
    { id: "D14645", name: "C12: NW Boundary A", lat: 38.991268, lon: -76.943237 },
    { id: "D17615", name: "C12: SE Border", lat: 38.908325, lon: -76.899002 },
    { id: "E10588", name: "C12: NW Boundary B", lat: 38.991806, lon: -76.943130 },
    { id: "D14646", name: "C12: Standalone NW", lat: 38.989586, lon: -76.940407 }
  ];

  let markerMap = {}, markerMeta = {};
  const map = L.map("map").setView([38.922, -76.915], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  const chart = new Chart(document.getElementById("airChart").getContext("2d"), {
    type: "line",
    data: { datasets: [{ label: "AQI", data: [], borderColor: "#4477ce", tension: 0.1, fill: true, backgroundColor: "rgba(68, 119, 206, 0.1)" }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: "time" }, y: { beginAtZero: true } } }
  });

  async function proxyGet(params) {
    params._ts = Date.now();
    const url = API_PROXY + "?" + new URLSearchParams(params).toString();
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("404/500 Error");
      return await res.json();
    } catch (e) {
      console.error("Fetch Error:", e);
      return null;
    }
  }

  function aqiFromPM(pm) {
    if (!pm || pm < 0) return 0;
    const table = [{cl:0,ch:12,il:0,ih:50},{cl:12.1,ch:35.4,il:51,ih:100},{cl:35.5,ch:55.4,il:101,ih:150},{cl:55.5,ch:150.4,il:151,ih:200},{cl:150.5,ch:250.4,il:201,ih:300}];
    const b = table.find(r => pm <= r.ch) || table[table.length-1];
    return Math.round(((b.ih-b.il)/(b.ch-b.cl))*(pm-b.cl)+b.il);
  }

  function getAQIColor(aqi) {
    if (aqi <= 50) return "#00e400";
    if (aqi <= 100) return "#ffff00";
    if (aqi <= 150) return "#ff7e00";
    return "#ff0000";
  }

  function makeSpodIcon(color) {
    return L.divIcon({ className: "spod-tri", html: `<div style="width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:20px solid ${color};filter:drop-shadow(0 0 1px #000);"></div>`, iconSize: [20, 20], iconAnchor: [10, 20] });
  }

  async function updateDisplay(id) {
    let currentAQI = 0, ce24 = 0, history = [], name = "";

    if (id.startsWith("D") || id.startsWith("E")) {
      name = markerMeta[id].name;
      const json = await proxyGet({ action: "grove_history", compId: id });
      
      // Look for the PM2.5 stream (or first numerical stream)
      const streams = json?.stream || [];
      const pmStream = streams.find(s => s.feed && s.feed.length > 0);

      if (pmStream) {
        const samples = pmStream.feed;
        const lastVal = samples[samples.length - 1].v;
        currentAQI = aqiFromPM(lastVal);
        const avgVal = samples.reduce((a, b) => a + b.v, 0) / samples.length;
        ce24 = aqiFromPM(avgVal);
        history = samples.map(s => ({ x: s.t, y: aqiFromPM(s.v) }));
      }
    } else {
      name = SENSORS[id];
      const start = Math.floor(Date.now()/1000) - 86400;
      const json = await proxyGet({ action: "purpleair_history", id, start });
      if (json?.data) {
        currentAQI = aqiFromPM(json.data[json.data.length-1][1]);
        ce24 = aqiFromPM(json.data.reduce((a,b)=>a+b[1],0)/json.data.length);
        history = json.data.map(r => ({ x: r[0]*1000, y: aqiFromPM(r[1]) }));
      }
    }

    document.getElementById("statName").innerText = name;
    document.getElementById("statAQI").innerText = currentAQI;
    document.getElementById("statAQI").style.color = getAQIColor(currentAQI);
    document.getElementById("statCE").innerText = ce24;
    document.getElementById("statCE").style.color = getAQIColor(ce24);
    
    chart.data.datasets[0].data = history;
    chart.update();

    const color = getAQIColor(ce24);
    const m = markerMap[id];
    if (id.startsWith("D")) m.setIcon(makeSpodIcon(color));
    else m.setStyle({ fillColor: color });
  }

  function handleDropdownChange(id) {
    map.flyTo(markerMap[id].getLatLng(), 15);
    updateDisplay(id);
  }

  function init() {
    const sel = document.getElementById("devSel");
    C12_STATIONS.forEach(s => {
      const m = L.marker([s.lat, s.lon], { icon: makeSpodIcon("#999") }).addTo(map);
      markerMap[s.id] = m; markerMeta[s.id] = { name: s.name };
      sel.add(new Option(s.name, s.id));
      m.on("click", () => { sel.value = s.id; handleDropdownChange(s.id); });
    });
    // Add default PA for now
    Object.keys(SENSORS).forEach(id => {
       sel.add(new Option(SENSORS[id], id));
       // We'd add PA circle markers here
    });

    sel.value = "D14781";
    handleDropdownChange("D14781");
  }

  init();
</script>
</body>
</html>
