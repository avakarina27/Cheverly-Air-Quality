<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EJAT Cheverly | Cumulative AQI (CE-AQI) Dashboard</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --brand-navy: #1a305e; --search-blue: #4477ce; }
        body { margin: 0; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; height: 100vh; background: #fdfdfd; }
        header { background: var(--brand-navy); color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #ff7e00; }
        #layout { display: flex; flex: 1; overflow: hidden; }
        #sidebar { width: 380px; min-width: 380px; background: #f4f6f8; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        #main-content { flex: 1; display: flex; flex-direction: column; }
        #map { height: 45%; border-bottom: 1px solid #ccc; }
        #chart-box { flex: 1; padding: 20px; background: white; }
        .card { background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .aqi-val { font-size: 84px; font-weight: 900; display: block; text-align: center; line-height: 1; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); transition: color 0.3s; }
        .adder-line { font-size: 0.85rem; color: #444; border-left: 4px solid var(--search-blue); padding-left: 10px; margin: 8px 0; background: #f0f7ff; padding-top: 5px; padding-bottom: 5px; border-radius: 0 5px 5px 0; }
        h3 { margin-top: 0; color: var(--brand-navy); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; }
        select { width: 100%; padding: 12px; border-radius: 5px; border: 1px solid #ccc; font-size: 1rem; }
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; background: #eee; margin-bottom: 10px; }
    </style>
</head>
<body>

<header>
    <div><strong>EJAT Cheverly</strong> | CE-AQI Network</div>
    <div id="status-clock" style="font-size: 0.85rem; opacity: 0.9;">System Active: Feb 2026</div>
</header>

<div id="layout">
    <aside id="sidebar">
        <div class="card">
            <h3>Monitor Location</h3>
            <select id="stationSelect" onchange="updateDashboard(this.value)"></select>
        </div>

        <div class="card" style="text-align: center;">
            <div id="siteTypeBadge" class="badge">--</div>
            <h3>24-HR Cumulative Index (CE-AQI)</h3>
            <div id="mainAQI" class="aqi-val" style="color: #ccc;">--</div>
            <div id="aqiCategory" style="font-weight: bold; margin-top: 15px; font-size: 1.1rem;">--</div>
        </div>

        <div class="card">
            <h3>Health Risk Breakdown</h3>
            <div id="breakdownList" style="margin-top: 10px;">Select a station on the map or list...</div>
        </div>
    </aside>

    <div id="main-content">
        <div id="map"></div>
        <div id="chart-box">
            <canvas id="aqiChart"></canvas>
        </div>
    </div>
</div>

<script>
// --- 1. SENSOR DATABASE (Including your new C-12 IDs) ---
const STATIONS = [
    { id: "D14781", name: "C12: Cheverly Sector", lat: 38.92054,  lng: -76.919716, type: "C12" },
    { id: "D14645", name: "C12: NW Boundary A", lat: 38.991268, lng: -76.943237, type: "C12" },
    { id: "D17615", name: "C12: SE Border",     lat: 38.908325, lng: -76.899002, type: "C12" },
    { id: "E10588", name: "C12: NW Boundary B", lat: 38.991806, lng: -76.943130, type: "C12" },
    { id: "D14646", name: "C12: Standalone NW", lat: 38.989586, lng: -76.940407, type: "C12" },
    { id: "PA_203577", name: "Cheverly Supersite", lat: 38.922, lon: -76.915, type: "SUPERSITE" }
];

// --- 2. 2026 EPA BREAKPOINTS (PM2.5 Good @ 9.0) ---
const BP_PM25 = [
    { cLo: 0, cHi: 9.0, iLo: 0, iHi: 50 },     // NEW 2026 STANDARD
    { cLo: 9.1, cHi: 35.4, iLo: 51, iHi: 100 },
    { cLo: 35.5, cHi: 55.4, iLo: 101, iHi: 150 },
    { cLo: 55.5, cHi: 125.4, iLo: 151, iHi: 200 }
];

// --- 3. THE CE-AQI MATH ENGINE ---

function calculateAQI(conc, breakpoints) {
    const bp = breakpoints.find(b => conc >= b.cLo && conc <= b.cHi);
    if (!bp) return conc > 500 ? 500 : 0;
    return Math.round(((bp.iHi - bp.iLo) / (bp.cHi - bp.cLo)) * (conc - bp.cLo) + bp.iLo);
}

function processSiteData(raw) {
    let aqis = {};
    
    // PM2.5 (24hr)
    if (raw.pm25) aqis["PM2.5"] = calculateAQI(raw.pm25, BP_PM25);
    
    // Ozone (8hr)
    if (raw.o3) aqis["Ozone"] = calculateAQI(raw.o3, [{cLo:0, cHi:54, iLo:0, iHi:50}, {cLo:55, cHi:70, iLo:51, iHi:100}]);

    // Diesel PM (Black Carbon * 80% / 33ng benchmark)
    if (raw.bc) {
        const dpm = raw.bc * 0.80; // Multiplier from protocol
        aqis["Diesel PM"] = Math.round((dpm / 33) * 100);
    }

    return aqis;
}

function calculateFinalCE(aqiMap) {
    const entries = Object.entries(aqiMap);
    if (!entries.length) return { score: 0, adders: [] };

    // Find Base Value (Highest Individual Pollutant)
    let base = { name: "", val: 0 };
    entries.forEach(([name, val]) => {
        if (val > base.val) base = { name, val };
    });

    // Apply Cumulative Adders (1%, 2%, 3% rules)
    let sumAdders = 0;
    let adderNotes = [];

    entries.forEach(([name, val]) => {
        if (name === base.name) return;
        
        let pct = 0;
        if (val >= 120) pct = 0.03;
        else if (val >= 100) pct = 0.02;
        else if (val >= 80) pct = 0.01;

        if (pct > 0) {
            let points = base.val * pct;
            sumAdders += points;
            adderNotes.push(`${name} (+${points.toFixed(1)} pts based on ${pct*100}% cumulative risk)`);
        }
    });

    return {
        total: Math.round(base.val + sumAdders),
        baseName: base.name,
        baseVal: base.val,
        adders: adderNotes
    };
}

// --- 4. UI & MAP HANDLING ---

const map = L.map('map').setView([38.922, -76.915], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

function getAQIColor(val) {
    if (val <= 50) return "#00e400";
    if (val <= 100) return "#ffff00";
    if (val <= 150) return "#ff7e00";
    if (val <= 200) return "#ff0000";
    return "#8f3f97";
}

function updateDashboard(stationId) {
    const station = STATIONS.find(s => s.id === stationId);
    
    // Mock Data - In production, fetch current readings from your API here
    const mockRaw = { 
        pm25: station.type === "C12" ? 8.5 : 14.2, 
        bc: station.type === "C12" ? 520 : 110,
        o3: 42 
    };

    const aqis = processSiteData(mockRaw);
    const ce = calculateFinalCE(aqis);

    // Update Sidebar
    const mainEl = document.getElementById("mainAQI");
    mainEl.innerText = ce.total;
    mainEl.style.color = getAQIColor(ce.total);
    
    document.getElementById("siteTypeBadge").innerText = station.type;
    document.getElementById("aqiCategory").innerText = ce.total <= 50 ? "Good" : ce.total <= 100 ? "Moderate" : "Unhealthy for Sensitive Groups";
    
    let html = `<div style="margin-bottom:10px;"><b>Primary Pollutant:</b> ${ce.baseName} (${ce.baseVal})</div>`;
    if (ce.adders.length > 0) {
        ce.adders.forEach(note => html += `<div class="adder-line">${note}</div>`);
    } else {
        html += `<div style="color:#888; font-style:italic; font-size:0.8rem;">No secondary pollutants triggered cumulative adders.</div>`;
    }
    document.getElementById("breakdownList").innerHTML = html;
}

// Initial Population
const sel = document.getElementById("stationSelect");
STATIONS.forEach(s => {
    sel.add(new Option(s.name, s.id));
    L.marker([s.lat, s.lng || s.lon]).addTo(map)
     .bindPopup(`<b>${s.name}</b><br><button onclick="document.getElementById('stationSelect').value='${s.id}'; updateDashboard('${s.id}')">View Data</button>`);
});

updateDashboard(STATIONS[0].id);

</script>
</body>
</html>
